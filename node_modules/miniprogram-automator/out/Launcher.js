"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0});const path_1=__importDefault(require("path")),Connection_1=__importDefault(require("./Connection")),MiniProgram_1=__importDefault(require("./MiniProgram")),child_process_1=__importDefault(require("child_process")),getPort_1=__importDefault(require("licia/getPort")),toStr_1=__importDefault(require("licia/toStr")),isWindows_1=__importDefault(require("licia/isWindows")),fs_1=__importDefault(require("licia/fs")),waitUntil_1=__importDefault(require("licia/waitUntil")),concat_1=__importDefault(require("licia/concat")),sleep_1=__importDefault(require("licia/sleep")),endWith_1=__importDefault(require("licia/endWith")),isRelative_1=__importDefault(require("licia/isRelative"));class Launcher{async launch(t){const{cliPath:e=await this.resolveCliPath(),timeout:i=3e4,cwd:r="",account:o=""}=t;let{args:a=[]}=t,{projectPath:l}=t;const c=await getPort_1.default(t.port||9420);if(t.port&&t.port!==c)throw Error(`Port ${t.port} is in use, please specify another port`);if(!e)throw Error("Wechat web devTools not found, please specify cliPath option");if(isWindows_1.default&&endWith_1.default(e,".exe"))throw Error("cliPath is not correct, it's usually named as 'cli' or 'cli.bat'");if(!l)throw Error("projectPath is not provided");if(isRelative_1.default(l)&&(l=path_1.default.resolve(l)),!await fs_1.default.exists(l))throw Error(`Project path ${l} doesn't exist`);const n={detached:!0,stdio:"ignore"};r&&(n.cwd=r);let s=null,u=!1;a=concat_1.default(a,["--auto",l,"--auto-port",toStr_1.default(c)]),o&&(a=concat_1.default(a,["--auto-account",o]));try{const t=child_process_1.default.spawn(e,a,n);t.on("error",t=>{s=t}),t.on("exit",()=>{setTimeout(()=>{u=!0},15e3)}),t.unref()}catch(t){s=t}let _=null;if(await waitUntil_1.default(async()=>{try{return!(!s&&!u)||(_=await this.connectTool({wsEndpoint:`ws://127.0.0.1:${c}`}),!0)}catch(t){return!1}},i,1e3),_)await _.checkVersion();else{if(s)throw Error("Failed to launch wechat web devTools, please make sure cliPath is correctly specified");if(u)throw Error("Failed to launch wechat web devTools, please make sure http port is open")}return await sleep_1.default(5e3),_}async connect(t){const e=await this.connectTool(t);return await e.checkVersion(),e}async connectTool(t){let e;try{const i=await Connection_1.default.create(t.wsEndpoint);e=new MiniProgram_1.default(i)}catch(e){throw Error(`Failed connecting to ${t.wsEndpoint}, check if target project window is opened with automation enabled`)}return e}async resolveCliPath(){let t="";return t=isWindows_1.default?"C:/Program Files (x86)/Tencent/微信web开发者工具/cli.bat":"/Applications/wechatwebdevtools.app/Contents/MacOS/cli",await fs_1.default.exists(t)?t:""}}exports.default=Launcher;